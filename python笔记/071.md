1. crm关系管理系统

2. 使用者

   销售、班主任、助教、讲师、财务、boss、学生

3. 业务+技术点

   1. 注册、登陆、注销
      1. 用户表
      2. modelform：class Meta中的labels / models的verbosename
      3. 不属于任何字段的错误都在`__all__`中，**form_obj.non_field_errors**
   2. 登陆
      1. 登陆视图
         1. 获取用户名和密码并校验
         2. 失败：返回登陆页面并提示
         3. 成功：保存用户的pk到sessoin中。 user_id 以及登陆状态 is_login
         4. 跳转到一个页面
      2. 中间件
         1. process_request
         2. 白名单
         3. 校验：从session中获取到is_login，没有则跳转到登陆页面，有则把用户对象保存到request中（如：request.user_obj, user已经被定义）
   3. 客户管理
      1. 展示客户
         1. 展示不同字段(普通字段、choice字段`(get_字段名_display)`、外键对象(str方法), 自定义方法)
         2. 公户和私户
         3. 分页（限制4种）
         4. 模糊搜索（q）
      2. 新增和编辑
         1. modelform：两个url对应一个视图函数，一个模版
      3. 公户和私户的转换
   4. 跟进记录管理
      1. 展示
         1. 展示销售所有的跟进记录
         2. 展示某个客户的跟进记录
      2. 新增和编辑
         1. modelform
         2. 限制跟进人为当前用户
         3. 限制客户为当前用户的账户(修改字段的choices值)
   5. 报名表的管理

   ## 今日内容

   1. 公户转私户

   ```mysql
   # 数据库加行级锁
   begin;    # 开启事务
   select * from t1 where id=1 for update;   # 添加行级锁
   commit;   # 提交事务
   ```

   ```python
   # if ret: return ret
   
   
   from django.db import transaction
   pk = self.request.POST.getlist('pk')
   try:
     	with transaction.atomic():
       		queryset = models.Customer.objects.filter(pk__in=pk, consultant=None).select_for_update()
       		if len(pk) == queryset.count():
       				queryset.update(consultant=self.request.user_obj)
            else:
             	return HttpResponse('客户以被占用')
   except Exception as e:
     print(e)
   ```

   2. 私户的上限

   ```python
   # settings.py
   MAX_CUSTOMER_NUM = 150   # 配置只能是大写，通过django.conf 导入
   
   # 导入最大客户数
   from django.conf import settings
   settings.MAX_CUSTOMER_NUM
   ```

   ```python
   # urls.py
   from crm.view import consultant, auth
   ```

   ```python
   # 类中的相同功能，提取作为父类
   # 模版文件根据功能不同创建文件夹
   # 多对多关系，可以blank=True，不设置多对多关系
   ```

   - 能在后端完成的就在后端完成

   3. 批量插入
      - 创建学习记录

   ```python
   # 循环生成学习记录，连接数据库次数太多
   # 批量插入，列表存放需要插入数据库的对象，batch_size表示一次性插入数据量
   stu_li = []
   for stu in students:
      stu_li.append(models.StudyRecord(course_record=course_record, student=stu))
   models.StudyRecord.bulk_create(stu_li, batch_size=10)
   ```

   ```python
   # 查看学习记录
   # modelformset
   from django.forms import modelformset_factory
   def study_record(request):
       ModelFormSet = modelfromset_facotory(models.StudyRecord, StydyRecordForm, extra=0)
   
       fromset = ModelFromSet(queryset=models.StudyRecord.objects.fitler(course_record_id=course_record_id))
       if request.method == 'POST':
         	fromset = ModelFromSet(queryset=models.StudyRecord.objects.fitler(course_record_id=course_record_id), data=request.POST)
           if fromset.is_valid():
             	fromset.save()
               next = request.GET.get('next', '')
               if next:
               	return redirect(next)
               else:
                 return redirect('study_record', args=())
       return render(request, 'xx.html', {'formset': formset})
   ```

   

   ```django
   {# 不可修改 #}
   {{ form.instance }}                {# 一个原始数据的对象 #}
   {{ form.instance.student }} 
   {{ form.id }}
   
   {{ formset.management_form }}       {# 表单管理 #}
   {{ formset.errors }}                {# 错误信息 #}
   ```

   

   