## 内存管理

1.  python内部将数据类型分成了两类，单个元素组成和多个元素组成。利用不同结构体进行区分(**PyObject和PyvarObject**两个结构体）

    ```c
    // 单个元素
    typedef struct _object {
        _PyObject_HEAD_EXTRA			// 双向链表
        Py_ssize_t ob_refcnt;			// 引用计数器
        struct _typeobject *ob_type;	// 对象的类型
} PyObject;
    // 多个元素
    typedef struct {
        PyObject ob_base;				// PyObject结构体，包含以上3个变量
        Py_ssize_t ob_size; 			// 对象中的元素个数
    } PyVarObject;
    ```
    
    -   list、dict、set、tuple、str、int(**py3中字符串方式实现**)：由PyVarObject维护
    -   float、bool：由PyObject维护
    
2.  在python代码中，创建或者对对象赋值，将对象加入**双向链表**中，或**引用计数器加1**，如果执行对象的删除  `del 变量`， **引用计数器减1**，引用计数器为0，就将对象从双向链表中移除。

## 垃圾回收

1.  引用计数器为主，标记清除和分代回收为辅

2.  引用计数器：通过` ob_refcnt `进行计数(**循环引用的缺陷**)

3.  标记清除

    -   **由多个元素组成的可变类型对象可能会出现循环引用的问题**，引用计数可以满足基本的垃圾回收，但无法解决循环引用的问题

    -   在python中，会为由多个元素组成和单个元素组成的类型，各自维护两个双向链表，在gc中会**定期扫描**多个元素的对象组成的链表，如果发现有循环引用，各自的循环引用计数器会减1

    ```python
    v1 = [1]
    v2 = [2]
    v1.append(v2)
    v2.append(v1)
    ```

4.  分代回收

    1.  又引入两个链表，3个链表维护**多个元素组成的对象**，0代、1代、2代
    2.   pythonh中为多个元素组成的类型(循环引用)，维护了3个链表，分别是0代、1代、2代，python中默认对这3个链表设定了一个阈值(700, 10, 10)，第0代的链表中，如果对象达到700个对象，则进行一次扫描，10表示0代扫描10次，1代扫描1次...
    
3.  关于分代回收（generations）：
  
  The GC classifies objects into `three generations` depending on how many collection sweeps they have survived. New objects are placed in the youngest generation (generation `0`). If an object survives a collection it is moved into the next older generation. Since generation `2` is the oldest generation, objects in that generation remain there after a collection. In order to decide when to run, the collector keeps track of the number object allocations and deallocations since the last collection. When the number of allocations minus the number of deallocations exceeds **threshold0**, collection starts. Initially only generation `0` is examined. If generation `0` has been examined more than **threshold1** times since generation `1` has been examined, then generation `1` is examined as well. Similarly, **threshold2** controls the number of collections of generation `1` before collecting generation `2`.
  
    ```python
  # 默认情况下三个阈值为 (700,10,10) ，也可以主动去修改默认阈值。
  import gc
  gc.set_threshold(threshold0[, threshold1[, threshold2]])
    ```
  
  -   《python源码剖析》