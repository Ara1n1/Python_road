## Review

1. rbac基于角色的权限控制(一种方案)

2. 如何实现权限控制

   1. url代表权限
   2. 表结构
      1. 权限表：url 权限 url地址是正则表达式，不带^ 和 $、title：标题
      2. 角色表：name角色表名称、permissions**多对多**，blank=True
      3. 用户表：username、pwd、roles多对多，关联角色
      4. 角色权限表
      5. 用户角色表
   3. 一级菜单
      1. 权限表：增加 is_menu和 icon字段
   4. 二级菜单
      1. 菜单表：title、icon
      2. 权限表：去掉is_menu和icon，增加外键关联menu表(有menu_id表示当前是二级菜单)
   5. 二级菜单中，一级菜单进行排序
      1. 菜单表：增加weight字段，用于优先级排序
   6. 非菜单权限归属
      1. 权限表：增加parent自关联，partent_id(有则为子权限，无则表示父权限)
   7. 路径导航
      1. list中增加路径信息

   流程+技术点

   1. 中间件

      1. 获取当前url

      2. 白名单：re正则匹配、settings

      3. request.current_id = None

      4. request.breadcrump_list = [{'url':…, 'title': '首页'}]

      5. 验证登陆状态：没有登陆跳转到登陆页面

      6. 免认证地址：re 和settings

      7. 权限校验：

         1. 从sessoin中获取当前用户的权限信息

         2. 循环权限dict正则匹配，匹配成功直接return

            1. 记录menu_id和breadcrump_list

            2. 获取id pid

               有pid当前访问是子权限

               1. menu_id = pid
               2. p_permissin = permission_dict[str(pid)]
               3. request.breadcrump_list = [{'url':p_permisssion['url'], 'title': p_permisssion['title']}]
               4. request.breadcrump_list = [{'url':i['url'], 'title': i['title']}]

               没有pid当前访问是二级菜单

               1. menu_id = id
               2. request.breadcrump_list = [{'url':i['url'], 'title': i['title']}]
               3. return

         3. 拒绝请求，没有权限

   2. 登陆视图

      1. 验证用户名和密码。验证成功获取用户对象

      2. 权限信息和菜单信息初始化

         1. 获取当前用户的权限信息`obj.roles.filter('permissions__url__isnull=False').values(permissions__url...).distinct`

            - 跨表、去空、去重
            - 为用户分配角色，没有分配权限

         2. 构建数据结构：权限+菜单

            权限：

            1. 简单的权限控制permission_list = [{'permissions__url':url}]
            2. 非菜单的权限归属：url、id、pid
            3. 路径导航：permission_dict = { 权限id:{url id pid title} }，方便得到父权限的信息

            菜单：

            1. 动态生成一级菜单
               1. menu_list = [{'url': url, 'title': title, 'icon':..}]
            2. 二级菜单
               1. menu_dic = { 一级菜单id:{'title':.., 'icon':…,children:[{'url':…,'title':... }]}
               2. 一级菜单：+wieght
            3. 非菜单权限归属
               1. 二级菜单：+id

         3. 保存权限和菜单信息以及登陆状态到seesion(json序列化，字典key为数字，会变成string)

         4. 重定向到首页

      3. 模版

         1. 母版和继承
         2. 动态生成菜单：inclusion_tag、有序字典、sorted、js和css
         3. 路径导航
            1. inclusion_tag

## 今日内容

## 1. 没有权限标签隐藏

- 通过name 判断标签的url是否在，用户拥有的权限中

### 1. 修改表结构

```python
# permission
name = models.CharField('url别名',max_length=50, unique=True)
```

### 2. 获取name

- 通过pname获取父权限信息(路径导航)

```python
# models 获取
# 构造name_list = []
name和父权限name
permission_dict[i['permisssion__name']] = {}
```

### 3. 使用filter过滤

## 2. 权限分配菜单

### 1. 菜单table增加数据

### 2. 角色list

### 3. 菜单list

fa-mail-forward

verbose_name , labels 

`5|safe` :转换为string类型



















