## Review

## 1. 基本需求的表结构 

1. 权限表
   - url。权限(不包含^和$)
   - title  标题
2. 角色表
   - name
   - permissions = manytomanyfield
3. 角色和权限关系表
   - role_id 
   - permission_id
4. 用户名
   - username
   - pwd
   - roles = manytomanyfield
5. 用户和角色表
   - user_id
   - role_id

## 2. 菜单需求

1. 一级菜单
   - 权限表：多一个 is_menu 字段
   - icon：可有可无
2. 二级菜单
   - 新增：menu表：title icon 
     - permissoin只留url和title + 外键

## 今日内容

## 1. 一级菜单的排序

1. dict在3.6 是无序的，显示有序，3.7之后是有序的
2. 有序菜单(有序字典)
3. 给菜单加优先级
4. 使用有序字典，先排序后构造

```python
# model.py，优先级设置最好有些跨度
class Menu(models.Model):
    title = models.CharField('标题', max_length=32)
    icon = models.CharField('图标', max_length=100, null=True, blank=True)
    weight = models.IntegerField('优先级', default=1)

    def __str__(self):
        return self.title
```

```python
# my_tags.py
from collections import OrderDict
@register.inclusion_tag('menu.html')
def generator(request):
  	url = request.path
    menu_dic = request.session.get(settings.MENU_SESSION_KEY)
    od = OrderDict()
    # 排序，结果只有字典的 key
    keys = sorted(menu_dic, key=lambda x:menu_dic[x]['wight'] ,reverse=True)
    for i in keys:
        od[i] = menu_dic[i]
    
    for i in menu_dic.values():
      	i['class'] = 'hide'
      	for m in i['children']:
          	re.match(r'{}$'.format(m['url']), url)
            m['class'] = 'active'
            i['class'] = ''
    return {'menu_dic':od.values()}
```

### 1.2 二级菜单开合

```js
// 菜单的点击事件，功能就是“选项卡”
$('.title').click(function () {
    $(this).next().removeClass('hide');
    $(this).parent().siblings().find('.body').addClass('hide')
});
```

## 2. 二级菜单的子菜单

### 2.1 修改models.py

- url 即权限
- menu 外键，表示归属于哪个一级菜单
- parent 自关联外键，表示权限的归属关系(**属于哪一个二级菜单**)

```python
class Permission(models.Model):
    url = models.CharField('路径', max_length=100)
    title = models.CharField('标题', max_length=32)
    menu = models.ForeignKey('Menu', null=True, blank=True)
    parent = models.ForeignKey('self', null=True, blank=True)

    def __str__(self):
        return self.title
```

### 2.2 session的初始化

- 构造权限字典和菜单字典
- 需要权限的**id**和自关联外键parent，表明归属
- 菜单字典：键**children**需要当前**id**，**用于和当前权限的归属做判断**

```python
# init_session.py
from django.conf import settings
def init_session(request, obj):
    request.session['is_login'] = True
    permissions = obj.roles.exclude(permissions__url__isnull=True).values(
        'permissions__url',
        'permissions__title',
        'permissions__menu__icon',
        'permissions__menu__title',
        'permissions__menu_id',
        'permissions__menu__weight',
        'permissions__parent_id',
        'permissions__id',
    ).distinct()

    # 构造权限和菜单字典
    permission_dic = {}
    menu_dic = {}
    for i in permissions:
        permission_dic[i['permissions__id']] = {
            'url': i.get('permissions__url'),
            'title': i.get('permissions__title'),
            'id': i.get('permissions__id'),
            'pid': i.get('permissions__parent_id'),
            # id 和 pid 用于访问二级菜单中的子菜单时，保持二级菜单处于活跃状态
        }
        
        menu_id = i.get('permissions__menu_id')
        if menu_id:
            if not menu_dic.get(menu_id):
                menu_dic[menu_id] = {
                    'title': i.get('permissions__menu__title'),
                    'icon': i.get('permissions__menu__icon'),
                    'weight': i.get('permissions__menu__weight'),
                    'children': [
                        {'title': i.get('permissions__title'),
                         'url': i.get('permissions__url'),
                         'id': i.get('permissions__id'),
                         }]}
             else:
                menu_dic[menu_id]['children'].append(
                    {'title': i.get('permissions__title'),
                     'url': i.get('permissions__url'),
                     'id': i.get('permissions__id'),
                     })
    # 权限列表
    request.session[settings.PERMISSION_SESSION_KEY] = permission_dic
    # 菜单列表
    request.session[settings.MENU_SESSION_KEY] = menu_dic

```

### 2.3 获取当前url的归属

- 通过 Middleware 获取，只要接收到请求，就要判别其归属

```python
# 权限校验,中间件
for i in permissions:
  	if re.match(r'{}$'.format(i['url']), path):
        sid = i['id']
        pid = i['pid']
        if pid:
            request.current_menu_id = sid
        else:
            request.current_menu_id = id
        return 
```

### 2.4 inclusion_tag

- 用于样式的定制和修改

```python
# my_tags.py
from collections import OrderedDict
from django.conf import settings
from django.template import Library

register = Library()
@register.inclusion_tag('menu.html')
def menu(request):
    menu_dic = request.session.get(settings.MENU_SESSION_KEY)
    # print(menu_dic.values())
    # 通过有序字典，为一级菜单指定顺序
    od = OrderedDict()
    keys = sorted(menu_dic, key=lambda x: menu_dic[x]['weight'], reverse=True)
    for i in keys:
        od[i] = menu_dic[i]
    
    # 二级菜单样式
    for i in menu_dic.values():
        i['class'] = 'hide'
        for m in i['children']:
            # print(m['id'])
            if request.current_menu_id == m['id']:
                m['class'] = 'active'
                i['class'] = ''
    return {'menu_dic': od}
```

## 3. 路径导航(breadcrumb)

- json序列化时，字典中的**key**为数字为时，会变成字符串，反序列化后还是字符串
- 添加父权限导航
  - 数据库查询
  - pid 循环字典
  - 改变数据结构



























